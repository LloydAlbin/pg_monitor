\connect pgmonitor_db

-- Setup Test Variables
\set test_name 'data'
\set test_user 'grafana'
\set test_production_database 'pgmonitor_db'
\set plan 14

-- Install pgTAP, show diagnostics, and start common tests
--\ir ../common/diagnostic.sql
\i common/diagnostics.pg

SELECT diag('SET TIME ZONE PST8PDT');
SET TIME ZONE 'PST8PDT';

SELECT diag('=================================');
SELECT diag('Test logs.connection_attempt_history()');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''5s'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:00:59''$$, ARRAY[''db1''], ''1s'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint),
        ('2020-01-18 19:00:05-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:10-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:15-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:20-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:25-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:30-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:35-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:40-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:45-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:50-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:55-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 1s avg to 5s');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''1s'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:00:11''$$, ARRAY[''db1''], ''1s'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint),
        ('2020-01-18 19:00:01-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:02-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:03-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:04-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:05-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:06-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:07-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:08-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:09-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:10-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:11-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 1s avg to 1s');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''min'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 15m min to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''max'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,3::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 15m max to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,2::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 15m avg to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''sum'', True);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1 - 1h Inverval'::text,5::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 15m sum to 1h with Interrval Display');

SELECT results_eq(
    E'SELECT * FROM logs.connection_attempt_history(''15m'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''1h'', ''sum'', True, true);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1 - 15m Inverval - sum'::text,5::bigint)
    $$,'Verify Data from function logs.connection_attempt_history - 1h sum to 15m with Interval Display and Agregate Display');

SELECT diag('=================================');
SELECT diag('Test logs.connection_history()');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''5s'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:00:59''$$, ARRAY[''db1''], ''1s'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint),
        ('2020-01-18 19:00:05-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:10-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:15-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:20-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:25-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:30-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:35-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:40-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:45-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:50-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:55-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint)
    $$,'Verify Data from function logs.connection_history - 1s avg to 5s');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''1s'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:00:11''$$, ARRAY[''db1''], ''1s'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint),
        ('2020-01-18 19:00:01-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:02-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:03-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:04-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:05-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:06-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:07-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:08-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:09-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:10-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint),
        ('2020-01-18 19:00:11-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,0::bigint)
    $$,'Verify Data from function logs.connection_history - 1s avg to 1s');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''min'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,1::bigint)
    $$,'Verify Data from function logs.connection_history - 15m min to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''max'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,3::bigint)
    $$,'Verify Data from function logs.connection_history - 15m max to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''avg'', False);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1'::text,2::bigint)
    $$,'Verify Data from function logs.connection_history - 15m avg to 1h');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''1h'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''15m'', ''sum'', True);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1 - 1h Inverval'::text,5::bigint)
    $$,'Verify Data from function logs.connection_history - 15m sum to 1h with Interrval Display');

SELECT results_eq(
    E'SELECT * FROM logs.connection_history(''15m'', $$log_time BETWEEN ''2020-01-18T19:00:00'' AND ''2020-01-18T19:59:59''$$, ARRAY[''db1''], ''1h'', ''sum'', True, true);',
    $$VALUES
        ('2020-01-18 19:00:00-08'::TIMESTAMP WITH TIME ZONE,'db1 - 15m Inverval - sum'::text,5::bigint)
    $$,'Verify Data from function logs.connection_history - 1h sum to 15m with Interval Display and Agregate Display');
