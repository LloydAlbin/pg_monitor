\connect pgmonitor_db

-- Setup Test Variables
\set test_name 'permissions'
\set test_user 'grafana'
\set test_production_database 'pgmonitor_db'
\set plan 73

-- Install pgTAP, show diagnostics, and start common tests
--\ir ../common/diagnostic.sql
\i common/diagnostics.pg

SELECT diag('Table Ownership Tests');
SELECT diag('=================================');
SELECT table_owner_is ( table_schema, table_name, :'test_user'::name )
FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema IN ('logs', 'stats', 'tools');

SELECT diag('=================================');
SELECT diag('View Ownership Tests');
SELECT diag('=================================');
SELECT view_owner_is ( table_schema, table_name, :'test_user'::name )
FROM information_schema.tables WHERE table_type = 'VIEW' AND table_schema IN ('logs', 'stats', 'tools');

SELECT diag('=================================');
SELECT diag('Function Ownership Tests');
SELECT diag('=================================');
SELECT function_owner_is (n.nspname, p.proname, p.proargtypes::regtype[]::name[], :'test_user')
FROM pg_catalog.pg_proc p
LEFT JOIN pg_catalog.pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname IN ('logs', 'stats', 'tools');
