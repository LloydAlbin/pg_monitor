language: bash
services: docker
sudo: required

# blocklist
#branches:
#  except:
#  - experimental

# safelist
#branches:
#  only:
#  - master

addons:
  apt:
    packages:
      - postgresql-client
      - perl
#      - libcurl4-openssl-dev
#      - libelf-dev
#      - libdw-dev
#      - cmake

#before_script: |
#  wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
#  tar xzf master.tar.gz &&
#  cd kcov-master &&
#  mkdir build &&
#  cd build &&
#  cmake .. &&
#  make &&
#  sudo make install &&
#  cd ../.. &&
#  rm -rf kcov-master &&
#  mkdir -p coverage

# https://blog.travis-ci.com/2017-10-26-running-kubernetes-on-travis-ci-with-minikube
# https://github.com/LiliC/travis-minikube
env:
  global:
    - CHANGE_MINIKUBE_NONE_USER=true
    - MINIKUBE_WANTUPDATENOTIFICATION=false
    - MINIKUBE_WANTREPORTERRORPROMPT=false
    - MINIKUBE_HOME=$HOME
    - CHANGE_MINIKUBE_NONE_USER=true
    - KUBECONFIG=$HOME/.kube/config
    - PGHOST=localhost
    - PGUSER=postgres
    - PGPASSWORD=pgpass
    - PGPORT=30002
    - KUBEVERSION=v1.17.0
    - MINIKUBEVERSION=v1.6.2

before_script:
  # Download kubectl, which is a requirement for using minikube.
  - curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/$KUBEVERSION/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
  # Download minikube.
  - curl -Lo minikube https://storage.googleapis.com/minikube/releases/$MINIKUBEVERSION/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
  - mkdir -p $HOME/.kube $HOME/.minikube
  - touch $KUBECONFIG
  - sudo minikube start --vm-driver=none --kubernetes-version=$KUBEVERSION
  - "sudo chown -R travis: /home/travis/.minikube/"
  # Add https://metacpan.org/pod/TAP::Parser::SourceHandler::pgTAP for pg_prove
  - cpanm --sudo TAP::Parser::SourceHandler::pgTAP


script:
  # Using the default build paramaters for a fresh build
  - ~/build/LloydAlbin/pg_monitor/timescaledb/custom/build_timescaledb.sh -v -v -v -V --add pgtap
  # Following is just to demo that the kubernetes cluster works.
  - kubectl cluster-info
  # Verify kube-addon-manager.
  # kube-addon-manager is responsible for managing other kubernetes components, such as kube-dns, dashboard, storage-provisioner..
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl -n kube-system get pods -lcomponent=kube-addon-manager -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1;echo "waiting for kube-addon-manager to be available"; kubectl get pods --all-namespaces; done
  # Wait for kube-dns to be ready.
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl -n kube-system get pods -lk8s-app=kube-dns -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1;echo "waiting for kube-dns to be available"; kubectl get pods --all-namespaces; done
  # Deploy Custom TimescaleDB with pgtap
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/timescaledb/kubernetes/pg-monitor-timescaledb-service.yaml
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/timescaledb/kubernetes/pg-monitor-timescaledb-secret.yaml
  #- kubectl apply -f ~/build/LloydAlbin/pg_monitor/timescaledb/kubernetes/pg-monitor-timescaledb-deployment.yaml
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/timescaledb/custom/kubernetes/pg-monitor-timescaledb-deployment.yaml
  # Make sure TimescaleDB pod is scheduled and running.
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl -n default get pods -lapp=pg-monitor-timescaledb -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1;echo "waiting for pg-monitor-timescaledb deployment to be available"; kubectl get pods -n default; done
  # Deploy Grafana
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/grafana/kubernetes/pg-monitor-grafana-service.yaml
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/grafana/kubernetes/pg-monitor-grafana-deployment.yaml
  # Make sure Grafana pod is scheduled and running.
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl -n default get pods -lapp=pg-monitor-grafana -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1;echo "waiting for pg-monitor-grafana deployment to be available"; kubectl get pods -n default; done
  # Deploy Graphite
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/graphite/kubernetes/pg-monitor-graphite-service.yaml
  - kubectl apply -f ~/build/LloydAlbin/pg_monitor/graphite/kubernetes/pg-monitor-graphite-deployment.yaml
  # Make sure Graphite pod is scheduled and running.
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl -n default get pods -lapp=pg-monitor-graphite -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1;echo "waiting for pg-monitor-graphite deployment to be available"; kubectl get pods -n default; done
  # Verify Postgres Version and Connection
  - psql -d postgres -c 'SELECT version();'
  # Install pg_monitor sql
  - psql -d postgres -f ~/build/LloydAlbin/pg_monitor/timescaledb/init_timescaledb.sql
  - psql -d postgres -c "ALTER ROLE grafana WITH PASSWORD 'pgpass';"
  #- psql -h localhost -p 30002 -d postgres -U postgres -f ~/build/LloydAlbin/pg_monitor/grafana/pg_monitor_timescaledb_init.sql
  # Must change directories to tune the pgtap tests.
  - cd ~/build/LloydAlbin/pg_monitor/pgtap_tests/
  # Run the all the pgtap tests in the pgtap_tests directory
  - pg_prove -v -d postgres .
  #- pg_prove -v -h localhost -p 30002 -d postgres -U postgres .

  # Note: Last build test took 18+ mintues

after_script:
  - docker images
  #- bash <(curl -s https://codecov.io/bash)>
  - kubectl get all
  - kubectl get secrets
  
# vim:set et ts=2 sw=2: